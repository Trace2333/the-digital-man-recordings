# 实验对照记录

## 初次实验出现的问题







## 排查步骤

### 使用未更改的模型结构搭配无误的外部训练和加载代码

![image-1](./images/1.png)

![image-2](./images/2.png)											![image-3](./images/3.png)

​										结构和计算流程

输入数据为没有经过window取词处理的序列并且embedding没有添加到更新参数表里

![image-4](/images/4.png)

![image-5](./images/5.png)

**可以发现仍然能够得到一定的效果（p=0.3,p1=0.3），初步排除结构问题**

### 增加embedding参数挂载

增加模型的embedding参数挂载观察是否能够得到对应的理想结果，排查当前结构对于embedding能否正常更新且它是否能正常起作用

![image-6](./images/6.png)

可见在之后即使没有按window进行分词也得到了比较理想的曲线，因此问题不在window分词和结构上

**因此得出原模型没有结构性问题，并且window分词对其精度归0没有影响，问题出现在训练代码上**

## 使用确认无误的模型代码+不确定问题点的训练代码

### 问题复现

![image-7](./images/7.png)

采用原先的训练代码时出现精度归0的情况，问题位置无误

![image-8](.\images\8.png)

![image-9](.\images\9.png)

![image-10](.\images\10.png)

为了排除训练代码中对数据处理不同造成的影响，debug查看了各个输入流程的数据维度和内容，无误



![image-11](.\images\11.png)

从梯度上看没有明显的原因，但很明显梯度曲线在快速归0并且与0之间距离小于1e-5这个量级，此时学习率设置为0.01，判断是梯度消失了，再次实验，调小学习率

### 流程和其他模块不变的基础上更改学习率

![image-12](.\images\12.png)

![image-13](.\images\13.png)

![image-14](.\images\14.png)

​												lr=1e-3,1e-4,1e-5的梯度数据

**可能是初始化的参数过小？**但是在更大的学习率测试中结果也没有变化。

已知预测输出被全部优化为0，显然是局部最优，下面做更换优化器的实验

### 只更换优化器并调节学习率实验

将SGD更改为Adam（lr=1e-4不变）

![image-15](.\images\15.png)

成功跳出局部最优，**因此问题出现在优化器上**

但是，SGD虽然是直白的随机优化，但其他优化器如这里使用的Adam也是随机优化的原理，为什么SGD总是得到局部最优？

### 定位问题在优化器，探查原因

对同一个学习率，不同优化器进行观察

![image-16](.\images\16.png)

![image-17](.\images\17.png)

![image-18](.\images\18.png)

![image-19](.\images\19.png)

对过程中的Weight曲线观察，可以发现只有在Adam优化器下参数有有效更新，除开参数初始化的不同外（多次运行实验已经说明和初始化的值没有明显关系），在SGD条件下参数都没有有效更新。

### 用无误的代码更换SGD来测试

![image-20](.\images\20.png)

测试发现问题再次复现，**因此多方确定问题在优化器选择上**

## 完成问题定位，从原理查找原因

![image-21](.\images\21.png)

从输入数据上是可以看出来，模型存在局部最优点，并且是比较接近于全局最优点的（当输出恒定为0的时候，loss在一个不是很大的值波动）。并且并不会由loss1和loss2相互影响（二者局部最优一致）。

在没有经过的初始点处就是一个比较平坦的位置，因此在SGD优化的时候难以感知到微小的梯度变化，那么很可能走错方向，即向局部最优优化或输出呈现随机状态，它由于没有加速度的概念，在陷入局部之后也很难跳出。参数更新程度也会非常小（grad在这个任务中很小）

## 防止出现交叉问题

为了防止优化器之外的问题，还进行了交叉测试，在Adam优化器条件下，其他因素如层初始化、embedding文件、dataset文件、lr等都没有造成明显的影响。

